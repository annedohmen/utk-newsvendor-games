{% extends "global/Base.html" %}
{% load staticfiles otree_tags %}

{% block title %} Decision making study {% endblock %}

{% block content %}

<script src="https://d3js.org/d3.v6.js"></script>
<!-- Add a slider -->
<!-- <input type="range" name="mySlider" id=mySlider min="10" max="100" value="50"> -->
<!-- <h2 class="otree-title" id="demandDistributionsTitle">&nbsp;Loading Demand Distributions...&nbsp;</h2> -->
<div class="flex align-items-center" id="demandDistributionsChart">
    <p id="demandDistributionsTitle">
        <br>
        &nbsp;Loading Demand Distributions...&nbsp;
    </p>
    <!-- <div class="vertical-center">
    </div> -->
</div>
<script>
    // $("._otree-content").hide();
    // var otreeTitle = $('#_otree-title').text();
    // $('#_otree-title').text(' Loading demand distributions... ');

    // set the dimensions and margins of the graph
    const margin = { top: 30, right: 30, bottom: 30, left: 50 },
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    const svg = d3.select("#demandDistributionsChart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    var getUrl = window.location;
    var baseUrl = getUrl.protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/').slice(1, 3).join("/");

    // get the data
    // d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/1_OneNum.csv").then(function (data) {
    d3.csv("{{ demand_distributions_csv }}")
        .then(function (data) {

            // add the x Axis
            const x = d3.scaleLinear()
                .domain([0, 1000])
                .range([0, width]);
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            // add the y Axis
            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 0.01]);
            svg.append("g")
                .call(d3.axisLeft(y));

            // Compute kernel density estimation
            let kde = kernelDensityEstimator(kernelEpanechnikov(7), x.ticks(30)) // 40

            // let density = kde(data.map(function (d) { return d.price; }))
            // // Plot the area
            // const curve = svg
            //     .append('g')
            //     .append("path")
            //     .attr("class", "mypath")
            //     .datum(density)
            //     .attr("fill", "#69b3a2")
            //     .attr("opacity", ".8")
            //     .attr("stroke", "#000")
            //     .attr("stroke-width", 1)
            //     .attr("stroke-linejoin", "round")
            //     .attr("d", d3.line()
            //         .curve(d3.curveBasis)
            //         .x(function (d) { return x(d[0]); })
            //         .y(function (d) { return y(d[1]); })
            //     );

            // two distributions
            let d1 = kde(data.map(function (d) { return d.d1; }))
            let d2 = kde(data.map(function (d) { return d.d2; }))
            // Plot the area
            svg.append('g')
                .append("path")
                .attr("class", "mypath")
                .datum(d1)
                .attr("fill", "#404080")
                .attr("opacity", ".8")
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("stroke-linejoin", "round")
                .attr("d", d3.line()
                    .curve(d3.curveBasis)
                    .x(function (d) { return x(d[0]); })
                    .y(function (d) { return y(d[1]); })
                );


            // Plot the area
            svg.append('g')
                .append("path")
                .attr("class", "mypath")
                .datum(d2)
                .attr("fill", "#69b3a2")
                .attr("opacity", ".8")
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("stroke-linejoin", "round")
                .attr("d", d3.line()
                    .curve(d3.curveBasis)
                    .x(function (d) { return x(d[0]); })
                    .y(function (d) { return y(d[1]); })
                );

            // Handmade legend
            svg.append("circle").attr("cx", 300).attr("cy", 30).attr("r", 6).style("fill", "#404080")
            svg.append("text").attr("x", 320).attr("y", 30).text("Distribution 1").style("font-size", "15px").attr("alignment-baseline", "middle")

            svg.append("circle").attr("cx", 300).attr("cy", 60).attr("r", 6).style("fill", "#69b3a2")
            svg.append("text").attr("x", 320).attr("y", 60).text("Distribution 2").style("font-size", "15px").attr("alignment-baseline", "middle")


            // A function that update the chart when slider is moved?
            function updateChart(binNumber) {
                // recompute density estimation
                kde = kernelDensityEstimator(kernelEpanechnikov(7), x.ticks(binNumber))
                density = kde(data.map(function (d) { return d.d1; }))


                // update the chart
                curve
                    .datum(density)
                    .transition()
                    .duration(1000)
                    .attr("d", d3.line()
                        .curve(d3.curveBasis)
                        .x(function (d) { return x(d[0]); })
                        .y(function (d) { return y(d[1]); })
                    );
            }

            // Listen to the slider?
            d3.select("#mySlider").on("change", function (d) {
                selectedValue = this.value
                updateChart(selectedValue)
            })

        })
        .then(() => {
            // $('#_otree-title').text(otreeTitle);
            // $("._otree-content").show();

            $("#demandDistributionsTitle").hide();
        });


    // Function to compute density
    function kernelDensityEstimator(kernel, X) {
        return function (V) {
            return X.map(function (x) {
                return [x, d3.mean(V, function (v) { return kernel(x - v); })];
            });
        };
    }
    function kernelEpanechnikov(k) {
        return function (v) {
            return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
        };
    }
</script>

<p>
    Please maximise your browser window, switch off phone/e-mail/music and anything else distracting.
</p>

<p>
    By proceeding you consent to participate in this study. You understand that all data will be kept confidential by
    the researcher.
    Your personal information will not be stored with the data. You are free to withdraw at any time without giving a
    reason.
</p>

<br>
{% formfield player.prolificcode label="Please enter your Prolific Academic Participant ID here:" %}
<br>

<p>
    This study has three parts. Part 1 will start when you click the Next button below. Your reward will depend on your
    performance on all parts, in a manner that is specified later.
</p>

<br>

<center>
    {% next_button %}
</center>

{% endblock %}
