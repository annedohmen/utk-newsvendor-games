<!-- Template "demandplanning/scripts.html": includes javascript utilities in various <script> tags to include in the app's main pages. -->


<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script src="https://d3js.org/d3.v6.js"></script>

<!-- miscellaneous javascript functions -->
<script>
    function getBaseURL() {
        var baseUrl = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.split('/').slice(1, 3).join("/");
        return baseUrl;
    }

    function show() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="show()">Click me!</button>
        this.style.display = "block";
    }

    function hide() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="hide()">Click me!</button>
        this.style.display = "none";
    }

    function showJsVarsDOM() {
        // proxy js_vars so that the stringify'd object show just the first 6 and last 6 values of "demand_rvs"
        var proxiedJsVarsHandler = {
            get: function(target, prop, receiver) {
                if (prop === "demand_rvs") {
                    return [...target.demand_rvs.slice(0, 6), '...', ...target.demand_rvs.slice(target.demand_rvs.length-6, target.demand_rvs.length)]
                } else {
                    return target[prop]
                }
            }
        }
        var proxiedJsVars = new Proxy(js_vars, proxiedJsVarsHandler);
        var jsVars = JSON.stringify(proxiedJsVars);
        console.log(`js_vars (Proxy):\n${jsVars}`);

        // show on page if there's a DOM tag with id="js-vars":
        if ($("#js-vars").length === 1 && $("#js-vars").text() === "") {
            $("#js-vars").text(JSON.stringify(js_vars));
        }
    }

    function hideJsVars() {
        if ($("#js-vars").length === 1) {
            //$("#js-vars")[0].style.display = "none";
            $("#js-vars").hide();
        }
    }

    function formatCurrency(amount, kwargs = { minimumFractionDigits: 0, maximumFractionDigits: 2}) {
        var { language_code, real_world_currency_code } = js_vars;
        var kwargs = {style: "currency", currency: real_world_currency_code, currencyDisplay: "narrowSymbol", ...kwargs};
        var currency = new Intl.NumberFormat(language_code + '-US', kwargs);
        return currency.format(amount);
    }
</script>


<!-- distribution-curve -->
<script>

    function resizeDistributionCurveSvg() {
        var aspect = 460 / 400;
        var width = $('#distribution-curve').width() * 1.05;
        var height = width / aspect;

        $('#distribution-curve-svg').css({
            'width': `${width}px`,
            'height': `${height}px`
        });
    }

    function plotDistributionCurve() {
        var chartId = "#distribution-curve";
        var width = 460, height = 400;
        var aspect = width / height;
        var chart = d3.select(chartId);

        function resizer() {
            var chart = d3.select("#distribution-curve");
            if(chart && chart.node()) {
                var targetWidth = chart.node().getBoundingClientRect().width;
                chart.attr("width", targetWidth);
                chart.attr("height", targetWidth / aspect);
            }
        }

        d3.select(window).on("resize", resizer);


        // var width = $("#distribution-curve").width(), height = $("#distribution-curve").height();

        // set the dimensions and margins of the graph
        var margin = { top: 30, right: 30, bottom: 30, left: 50 };
        //var width = width - margin.left - margin.right;
        //var height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*const svg = d3.select("#distribution-curve")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        */

        var svg = d3.select("#distribution-curve").append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "distribution-curve-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);


        resizeDistributionCurveSvg();


        var data = js_vars.demand_rvs;


        // add the x Axis
        var xmax = js_vars.variance_choice === "high"? 1400: 1000;
        var xAxis = d3.scaleLinear()
            .domain([0, xmax])
            .range([0, width]);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xAxis));

        // Compute kernel density estimation
        var kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(20)) // 40
        var density = kde(data);

        // compute yAxis bounds
        var vals = [];
        density.forEach(([bin, val]) => {
            vals.push(val);
        })
        // var meanstep = d3.mean(d3.sort(vals));
        var ymax = Math.max(...vals);

        // add the y Axis
        d3.scaleLinear().range([height, 0])
        var yAxis = d3.scaleLinear()
            .range([height, 0])
            .domain([0, ymax]); // 0.01
        var yticks = yAxis.ticks(10);
        var stepSize = yticks[1] - yticks[0]
        yAxis = yAxis.domain([0, yticks[yticks.length-1] + stepSize])
        svg.append("g")
            .call(d3.axisLeft(yAxis));

        // Plot the area
        const curve = svg
            .append('g')
            .append("path")
            .attr("class", "mypath")
            .datum(density)
            .style("fill", "#69b3a2")
            .attr("opacity", ".8")
            .attr("stroke", "#000")
            .attr("stroke-width", 1)
            .attr("stroke-linejoin", "round")
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );

        hideLoadingMessage();

        /* Listen to the slider?
        d3.select("#mySlider").on("change", function (d) {
            selectedValue = this.value;
            updateChart(selectedValue);
        });
        */

    }


    // A function that update the chart when slider is moved?
    function updateChart(binNumber) {
        showLoadingMessage();

        // recompute density estimation
        kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(binNumber));

        //density = kde(data.map(function (d) { return d.d1; }))
        density = kde(data);


        // update the chart
        curve
            .datum(density)
            .transition()
            .duration(1000)
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );
        hideLoadingMessage();
    }


    // Function to compute density
    function kernelDensityEstimator(kernel, X) {
        return function (V) {
            return X.map(function (x) {
                return [x, d3.mean(V, function (v) { return kernel(x - v); })];
            });
        };
    }
    function kernelEpanechnikov(k) {
        return function (v) {
            return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
        };
    }
    function showLoadingMessage() {
        $('#distribution-curve-loading-message').show();
    }
    function hideLoadingMessage() {
        $('#distribution-curve-loading-message').hide();
    }
</script>


<!-- unit-costs-table -->
<script>
    function updateUnitCostsTable() {
        var costsTable = $("#unit-costs-table")
        var costsWholesaleRow = $("#row-wcpu");
        var costsRetailRow = $("#row-rcpu");
        var costsHoldingRow = $("#row-hcpu");
        var wcpu = formatCurrency(js_vars.wcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );
        var rcpu = formatCurrency(js_vars.rcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );
        var hcpu = formatCurrency(js_vars.hcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );

        costsWholesaleRow.append(`<td id="row-wcpu">${wcpu}</td>`);
        costsRetailRow.append(`<td id="row-rcpu">${rcpu}</td>`);
        costsHoldingRow.append(`<td id="row-hcpu">${hcpu}</td>`);

    }
</script>

<!-- amounts-ordered-demanded-barchart -->
<script>
    function resizeAmountsOrderedDemandedBarchartSvg() {
        var aspect = 460 / 400;

        //var height = $('#amounts-ordered-demanded-barchart').height();
        //var width = height * aspect;

        var width = $('#amounts-ordered-demanded-barchart').width();
        var height = width / aspect;

        $('#game-history-svg').css({
            'width': `${width}px`,
            'height': `${height}px`
        });
    }
    function plotAmountsOrderedDemandedBarchart() {
        var chartId = "#amounts-ordered-demanded-barchart";
        var width = 460, height = 400;
        var aspect = width / height;
        var chart = d3.select("#amounts-ordered-demanded-barchart");

        function resizer() {
            var chart = d3.select("#amounts-ordered-demanded-barchart");
            if(chart && chart.node()) {
                var targetWidth = chart.node().getBoundingClientRect().width;
                chart.attr("width", targetWidth);
                chart.attr("height", targetWidth / aspect);
            }
        }

        d3.select(window).on("resize", resizer);

        // set the dimensions and margins of the graph
        var margin = {top: 50, right: 60, bottom: 30, left: 50};
        //var width = width - margin.left - margin.right;
        //var height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*var svg = chart
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
        */
        var svg = chart.append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "amounts-ordered-demanded-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);


        resizeAmountsOrderedDemandedBarchartSvg();


        var data = JSON.parse(JSON.stringify(js_vars.history));
        var removeKeys = Object.keys(data[0]).filter(k => !["du", "ou", "period"].includes(k));
        data.forEach(d => {
            d.ou = d.ou === null? 0: d.ou;
            d.du = d.du === null? 0: d.du;
            for (var i in removeKeys) {
                delete d[removeKeys[i]];
            }
        });
        var ymax = Math.max(...data.map(d => d.ou), ...data.map(d => d.du));
        var groups = data.map(d => d.period);
        var subgroups = Object.keys(data[0]).filter(key => ["ou","du"].includes(key));

        // Add X axis
        var xAxis = d3.scaleBand()
            .domain(groups)
            .range([0, width])
            .padding([0.2]);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xAxis).tickSize(0));

        // Add Y axis
        var yAxis = d3.scaleLinear()
            .domain([0, ymax? ymax: 100])
            .range([ height, 0 ]);
        var yticks = yAxis.ticks(10);
        var stepSize = yticks[1] - yticks[0]
        yAxis = yAxis.domain([0, yticks[yticks.length-1] + stepSize])
        svg.append("g")
            .call(d3.axisLeft(yAxis));

        // Another scale for subgroup position?
        var xSubgroup = d3.scaleBand()
            .domain(subgroups)
            .range([0, xAxis.bandwidth()])
            .padding([0.05]);

        var ouColor = '#377eb8';
        var duColor = '#4daf4a';

        // color palette = one color per subgroup
        var color = d3.scaleOrdinal()
            .domain(subgroups)
            .range([ouColor, duColor])


        // Show the bars
        svg.append("g")
            .selectAll("g")
            // Enter in data = loop group per group
            .data(data)
            .join("g")
                .attr("transform", d => `translate(${xAxis(d.period)}, 0)`)
            .selectAll("rect")
            .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
            .join("rect")
                .attr("x", function(d) { return xSubgroup(d.key); })
                .attr("y", function(d) { return yAxis(d.value); })
                .attr("width", xSubgroup.bandwidth())
                .attr("height", function(d) { return height - yAxis(d.value); })
                .attr("fill", function(d) { return color(d.key); })

        // Handmade legend
        svg.append("circle").attr("cx", width - margin.right*1.5 - 20).attr("cy", -10).attr("r", 6).style("fill", ouColor);
        svg.append("circle").attr("cx", width - margin.right*1.5 - 20).attr("cy", 20).attr("r", 6).style("fill", duColor);
        svg.append("text").attr("x", width - margin.right*1.5).attr("y", -10).text("Order quantity").style("font-size", "15px").attr("alignment-baseline","middle")
        svg.append("text").attr("x", width - margin.right*1.5).attr("y", 20).text("Demand quantity").style("font-size", "15px").attr("alignment-baseline","middle")

    };

</script>

<!-- game-history-table -->
<script>
    function updateGameHistoryTable() {
        var histTable = $("#game-history-table")
        var histTableHeader = $("#game-history-table thead tr");
        var histTableStockRow = $("#game-history-table #row-stock");
        var histTableOrderRow = $("#game-history-table #row-order");
        var histTableDemandRow = $("#game-history-table #row-demand");
        var histTableProfitRow = $("#game-history-table #row-profit");
        var histTableCProfitRow = $("#game-history-table #row-cprofit");
        for (var i=0; i < js_vars.history.length; i++) {
            var h = js_vars.history[i];
            var p = h.period;
            var su = h.su_before === null ? '': h.su_before;
            var ou = h.ou === null? '': h.ou;
            var du = h.du === null? '': h.du;
            var profit = h.profit === null? '': formatCurrency(h.profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );
            var cumulative_profit = h.cumulative_profit === null? '': formatCurrency(h.cumulative_profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );

            histTableHeader.append(`<th scope="col">${p}</th>`);
            histTableStockRow.append(`<td id="game-history-stock-${p}">${su}</td>`);
            histTableOrderRow.append(`<td id="game-history-order-${p}">${ou}</td>`);
            histTableDemandRow.append(`<td id="game-history-demand-${p}">${du}</td>`);
            histTableProfitRow.append(`<td id="game-history-profit-${p}">${profit}</td>`);
            histTableCProfitRow.append(`<td id="game-history-cprofit-${p}">${cumulative_profit}</td>`);
        }

    }
</script>


<!-- final-results-table -->
<script>
    function updateFinalResultsTable() {
        var finalResultsTable = $("#final-results-table")
        var finalResultsStockRow = $("#final-results-table #row-stock");
        var finalResultsOrderRow = $("#final-results-table #row-order");
        var finalResultsDemandRow = $("#final-results-table #row-demand");
        var finalResultsProfitRow = $("#final-results-table #row-profit");
        var h = js_vars.history[js_vars.history.length-1];
        var su = h.su_after === null ? '': h.su_after;
        var ou = h.ou === null? '': h.ou;
        var du = h.du === null? '': h.du;
        //var profit = h.profit === null? '': formatCurrency(h.profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );
        var cumulative_profit = h.cumulative_profit === null? '': formatCurrency(h.cumulative_profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );

        finalResultsStockRow.append(`<td id="final-results-stock">${su}</td>`);
        finalResultsOrderRow.append(`<td id="final-results-order">${ou}</td>`);
        finalResultsDemandRow.append(`<td id="final-results-demand">${du}</td>`);
        finalResultsProfitRow.append(`<td id="final-results-profit">${cumulative_profit}</td>`);

    }
</script>

<script>
    if (window.location.href.includes('/Decide/')) {
        plotDistributionCurve();
        updateUnitCostsTable();
        plotAmountsOrderedDemandedBarchart();
        updateGameHistoryTable();

        // var width = $("#participant-properties-row").width();
        var width = $("#distribution-curve").width();

        if($("#amounts-ordered-demanded-barchart").width() < width) {
            $("#amounts-ordered-demanded-barchart").width(width);
            $("#amounts-ordered-demanded-barchart").height(width / (460/400));
            resizeAmountsOrderedDemandedBarchartSvg();
        }

        if($("#game-history-table").width() < width) {
            $("#game-history-table").width(width);
        }
    } else {
        $("#distribution-unit-costs-row").hide();
        $("#history-row").hide();
    }

    if (window.location.href.includes('/FinalResults/')) {
        updateFinalResultsTable();
    } else {
        $("#final-results-row").hide();
    }

</script>
