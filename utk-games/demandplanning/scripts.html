<!-- Template "demandplanning/scripts.html": includes javascript utilities in various <script> tags to include in the app's main pages. -->


<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script src="https://d3js.org/d3.v6.js"></script>

<!-- miscellaneous javascript functions -->
<script>
    function getBaseURL() {
        var baseUrl = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.split('/').slice(1, 3).join("/");
        return baseUrl;
    }

    function show() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="show()">Click me!</button>
        this.style.display = "block";
    }

    function hide() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="hide()">Click me!</button>
        this.style.display = "none";
    }

    function showJsVarsDOM() {
        // proxy js_vars so that the stringify'd object show just the first 6 and last 6 values of "demand_rvs"
        var proxiedJsVarsHandler = {
            get: function(target, prop, receiver) {
                if (prop === "demand_rvs") {
                    return [...target.demand_rvs.slice(0, 6), '...', ...target.demand_rvs.slice(target.demand_rvs.length-6, target.demand_rvs.length)]
                } else {
                    return target[prop]
                }
            }
        }
        var proxiedJsVars = new Proxy(js_vars, proxiedJsVarsHandler);
        var jsVars = JSON.stringify(proxiedJsVars);
        console.log(`js_vars (Proxy):\n${jsVars}`);

        // show on page if there's a DOM tag with id="js-vars":
        if ($("#js-vars").length === 1 && $("#js-vars").text() === "") {
            $("#js-vars").text(JSON.stringify(js_vars));
        }
    }

    function hideJsVars() {
        if ($("#js-vars").length === 1) {
            //$("#js-vars")[0].style.display = "none";
            $("#js-vars").hide();
        }
    }

    function formatCurrency(amount, kwargs = { minimumFractionDigits: 0, maximumFractionDigits: 2}) {
        var { language_code, real_world_currency_code } = js_vars;
        var kwargs = {style: "currency", currency: real_world_currency_code, currencyDisplay: "narrowSymbol", ...kwargs};
        var currency = new Intl.NumberFormat(language_code + '-US', kwargs);
        return currency.format(amount);
    }
</script>


<!-- distribution chart -->
<script>

    function plotDistribution() {
        var chartId = "#distribution-chart";
        var width = 460, height = 400;
        var aspect = width / height;
        // var chart = d3.select(chartId)

        d3.select(window)
            .on("resize", function() {
                var chart = d3.select(chartId);
                if(chart) {
                    var targetWidth = chart.node().getBoundingClientRect().width;
                    chart.attr("width", targetWidth);
                    chart.attr("height", targetWidth / aspect);
                }
            });


        // var width = $("#distribution-chart").width(), height = $("#distribution-chart").height();


        // width = $('#chart-card').width() / 2;

        // set the dimensions and margins of the graph
        var margin = { top: 30, right: 30, bottom: 30, left: 50 },
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*const svg = d3.select("#distribution-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        */

        var svg = d3.select("#distribution-chart").append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "distribution-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);

        var width = $('#distribution-card').width()*.95;
        var height = width / aspect;

        $('#distribution-svg').css({
            //'width': $('#history-card').width() + 'px',
            //'height': $('#history-card').height() + 'px'
            'width': `${width}px`,
            'height': `${height}px`
        });


        var data = js_vars.demand_rvs;


        // add the x Axis
        var xmax = js_vars.variance === "high"? 1400: 1000;
        var xAxis = d3.scaleLinear()
            .domain([0, xmax])
            .range([0, width]);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xAxis));

        // Compute kernel density estimation
        var kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(20)) // 40
        var density = kde(data);

        // compute yAxis bounds
        var vals = [];
        density.forEach(([bin, val]) => {
            vals.push(val);
        })
        // var meanstep = d3.mean(d3.sort(vals));
        var ymax = Math.max(...vals);

        // add the y Axis
        d3.scaleLinear().range([height, 0])
        var yAxis = d3.scaleLinear()
            .range([height, 0])
            .domain([0, ymax]); // 0.01
        var yticks = yAxis.ticks(10);
        var stepSize = yticks[1] - yticks[0]
        yAxis = yAxis.domain([0, yticks[yticks.length-1] + stepSize])
        svg.append("g")
            .call(d3.axisLeft(yAxis));

        // Plot the area
        const curve = svg
            .append('g')
            .append("path")
            .attr("class", "mypath")
            .datum(density)
            .style("fill", "#69b3a2")
            .attr("opacity", ".8")
            .attr("stroke", "#000")
            .attr("stroke-width", 1)
            .attr("stroke-linejoin", "round")
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );

        hideLoadingMessage();

        /* Listen to the slider?
        d3.select("#mySlider").on("change", function (d) {
            selectedValue = this.value;
            updateChart(selectedValue);
        });
        */

    }


    // A function that update the chart when slider is moved?
    function updateChart(binNumber) {
        showLoadingMessage();

        // recompute density estimation
        kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(binNumber));

        //density = kde(data.map(function (d) { return d.d1; }))
        density = kde(data);


        // update the chart
        curve
            .datum(density)
            .transition()
            .duration(1000)
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );
        hideLoadingMessage();
    }


    // Function to compute density
    function kernelDensityEstimator(kernel, X) {
        return function (V) {
            return X.map(function (x) {
                return [x, d3.mean(V, function (v) { return kernel(x - v); })];
            });
        };
    }
    function kernelEpanechnikov(k) {
        return function (v) {
            return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
        };
    }
    function showLoadingMessage() {
        $('#distribution-chart #loading-message').show();
    }
    function hideLoadingMessage() {
        $('#distribution-chart #loading-message').hide();
    }
</script>

<!-- d3 sample bar chart -->
<script>

    function plotHistory() {
        var width = 460, height = 400;
        var aspect = width / height;
        var chart = d3.select("#distribution-chart");

        d3.select(window)
            .on("resize", function() {
                var chart = d3.select("#distribution-chart");
                var targetWidth = chart.node().getBoundingClientRect().width;
                chart.attr("width", targetWidth);
                chart.attr("height", targetWidth / aspect);
            });

        // var width = $("#history-chart").width(), height = $("#history-chart").height();

        // width = $('#chart-card').width() / 2;

        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 20, left: 50},
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#history-chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);

        // Parse the Data
        d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_stacked.csv").then(function(data) {

            window.d = data;

            // List of subgroups = header of the csv files = soil condition here
            var subgroups = data.columns.slice(1);

            // List of groups = species here = value of the first column called group -> I show them on the X axis
            const groups = data.map(d => d.group)

            //console.log(groups)

            // Add X axis
            const x = d3.scaleBand()
                .domain(groups)
                .range([0, width])
                .padding([0.2])
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x).tickSize(0));

            // Add Y axis
            const y = d3.scaleLinear()
                .domain([0, 40])
                .range([ height, 0 ]);
            svg.append("g")
                .call(d3.axisLeft(y));

            // Another scale for subgroup position?
            const xSubgroup = d3.scaleBand()
                .domain(subgroups)
                .range([0, x.bandwidth()])
                .padding([0.05])

            // color palette = one color per subgroup
            const color = d3.scaleOrdinal()
                .domain(subgroups)
                .range(['#e41a1c','#377eb8','#4daf4a'])

            // Show the bars
            svg.append("g")
                .selectAll("g")
                // Enter in data = loop group per group
                .data(data)
                .join("g")
                .attr("transform", d => `translate(${x(d.group)}, 0)`)
                .selectAll("rect")
                .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
                .join("rect")
                .attr("x", d => xSubgroup(d.key))
                .attr("y", d => y(d.value))
                .attr("width", xSubgroup.bandwidth())
                .attr("height", d => height - y(d.value))
                .attr("fill", d => color(d.key));

        });
    }
</script>

<!-- Becker-Peth history barchart -->
<script>
    function plotBeckerPethHistoryChart() {
        var chartId = "#history-chart";
        var width = 460, height = 400;
        var aspect = width / height;
        // var chart = d3.select(chartId)

        d3.select(window)
            .on("resize", function() {
                var chart = d3.select(chartId);
                if(chart) {
                    var targetWidth = chart.node().getBoundingClientRect().width;
                    chart.attr("width", targetWidth);
                    chart.attr("height", targetWidth / aspect);
                }
            });

        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 30, left: 50},
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*var svg = d3.select("#history-chart")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
        */
        var svg = d3.select("#history-chart").append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "history-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);

        /*var height = $('#history-card').height()*.95;
        var width = aspect * height;
        */
        var width = $('#history-card').width()*.95;
        var height = width / aspect;

        $('#history-svg').css({
            //'width': $('#history-card').width() + 'px',
            //'height': $('#history-card').height() + 'px'
            'width': `${width}px`,
            'height': `${height}px`
        });


        var data = JSON.parse(JSON.stringify(js_vars.history));
        data.forEach(d => {
            d.ou = !d.ou? 0: d.ou;
            d.du = !d.du? 0: d.du;
        });
        var groups = data.map(d => d.period);
        var subgroups = Object.keys(data[0]).filter(key => ["ou","du"].includes(key));

        // Add X axis
        var x = d3.scaleBand()
            .domain(groups)
            .range([0, width])
            .padding([0.2]);

        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickSize(0));

        // Add Y axis
        var y = d3.scaleLinear()
            .domain([0, 1000])
            .range([ height, 0 ]);

        svg.append("g")
            .call(d3.axisLeft(y));

        // Another scale for subgroup position?
        var xSubgroup = d3.scaleBand()
            .domain(subgroups)
            .range([0, x.bandwidth()])
            .padding([0.05]);

        // color palette = one color per subgroup
        var color = d3.scaleOrdinal()
            .domain(subgroups)
            .range(['#e41a1c','#377eb8','#4daf4a'])

        // Show the bars
        svg.append("g")
            .selectAll("g")
            // Enter in data = loop group per group
            .data(data)
            .enter()
            .append("g")
            .attr("transform", function(d) { return "translate(" + x(d.group) + ",0)"; })
            .selectAll("rect")
            .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
            .enter().append("rect")
            .attr("x", function(d) { return xSubgroup(d.key); })
            .attr("y", function(d) { return y(d.value); })
            .attr("width", xSubgroup.bandwidth())
            .attr("height", function(d) { return height - y(d.value); })
            .attr("fill", function(d) { return color(d.key); });

    };

</script>

<!-- Becker-Peth table -->
<script>
    function updateBeckerPethTable() {
        // var width = $("#distribution-card").width();
        var histTable = $("#history-table")
        var histTableHeader = $("#history-table thead tr");
        var histTableStockRow = $("#row-stock");
        var histTableStockOrder = $("#row-order");
        var histTableStockDemand = $("#row-demand");
        var histTableStockProfit = $("#row-cumulative-profit");
        for (var i=0; i < js_vars.history.length; i++) {
            var h = js_vars.history[i];
            var p = h.period;
            var su = h.su === null ? '': h.su;
            var ou = h.ou === null? '': h.ou;
            var du = h.du === null? '': h.du;
            var cumulative_profit = h.cumulative_profit === null? '': h.cumulative_profit;
            //var formatted_cumulative_profit = h.formatted_cumulative_profit === null? '': h.formatted_cumulative_profit;
            var formatted_cumulative_profit = cumulative_profit === ''? '': formatCurrency(cumulative_profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );

            histTableHeader.append(`<th scope="col">${p}</th>`);
            histTableStockRow.append(`<td id="row-stock-${p}">${su}</td>`);
            histTableStockOrder.append(`<td id="row-order-${p}">${ou}</td>`);
            histTableStockDemand.append(`<td id="row-demand-${p}">${du}</td>`);
            histTableStockProfit.append(`<td id="row-cumulative-profit-${p}">${formatted_cumulative_profit}</td>`);
        }

        if($("#history-table").width() < $("#distribution-card").width()) {
            $("#history-table").width($("#distribution-card").width());
        }
    }
    /*for (var i=0; i < js_vars.history.length; i++) {
        var h = js_vars.history[i];
        var p = h.period;
        var su = !h.su? 0: h.su;
        var ou = !h.ou? 0: h.ou;
        var du = !h.du? 0: h.du;
        var cumulative_profit = !h.cumulative_profit? 0: h.cumulative_profit;

        console.log(`${i}, ${JSON.stringify(h)}, ${su}, ${ou}, ${du}, ${cumulative_profit}`)
    }
    */
</script>

<script>
    plotDistribution();
    // plotHistory();
    plotBeckerPethHistoryChart();
    updateBeckerPethTable();
</script>
