<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script src="https://d3js.org/d3.v6.js"></script>

<!-- miscellaneous javascript functions -->
<script>
    function getBaseURL() {
        var baseUrl = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.split('/').slice(1, 3).join("/");
        return baseUrl;
    }

    function show() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="show()">Click me!</button>
        this.style.display = "block";
    }

    function hide() {
        // @notice: use only in 'onclick' HTMLElement attribute:  <button onclick="hide()">Click me!</button>
        this.style.display = "none";
    }

    function showJsVarsDOM() {
        // proxy js_vars so that the stringify'd object show just the first 6 and last 6 values of "demand_rvs"
        var proxiedJsVarsHandler = {
            get: function(target, prop, receiver) {
                if (prop === "demand_rvs") {
                    return [...target.demand_rvs.slice(0, 6), '...', ...target.demand_rvs.slice(target.demand_rvs.length-6, target.demand_rvs.length)]
                } else {
                    return target[prop]
                }
            }
        }
        var proxiedJsVars = new Proxy(js_vars, proxiedJsVarsHandler);
        var jsVars = JSON.stringify(proxiedJsVars);
        console.log(`js_vars (Proxy):\n${jsVars}`);

        // show on page if there's a DOM tag with id="js-vars":
        if ($("#js-vars").length === 1 && $("#js-vars").text() === "") {
            $("#js-vars").text(JSON.stringify(js_vars));
        }
    }

    function hideJsVars() {
        if ($("#js-vars").length === 1) {
            //$("#js-vars")[0].style.display = "none";
            $("#js-vars").hide();
        }
    }

    function formatCurrency(n, kwargs = { minimumFractionDigits: 0, maximumFractionDigits: 2}) {
        var { language_code, real_world_currency_code } = js_vars;
        var kwargs = {style: "currency", currency: real_world_currency_code, currencyDisplay: "narrowSymbol", ...kwargs};
        var formatter = new Intl.NumberFormat(language_code + '-US', kwargs);
        return formatter.format(n);
    }
    function formatNumber(n, kwargs = { minimumFractionDigits: 0, maximumFractionDigits: 2}) {
        var { language_code } = js_vars;
        var formatter = new Intl.NumberFormat(language_code + '-US', kwargs);
        return formatter.format(n);
    }

    function orderQuantityColor() {
        // original: '#377eb8'
        // '#ff56c6'
        // '#aa3382'
        return '#aa3382'
    }
    function demandQuantityColor() {
        // original: '#4daf4a'
        // '#6160eb'
        // '#60d3eb'
        return '#60d3eb'
    }
</script>


<!-- distribution-curve -->
<script>

    function resizeDistributionCurveSvg() {
        var aspect = 460 / 400;
        var width = $('#distribution-curve').width() * 1.05;
        var height = width / aspect;

        $('#distribution-curve-svg').css({
            'width': `${width}px`,
            'height': `${height}px`
        });
    }

    function plotDistributionCurve() {
        var chartId = "#distribution-curve";
        var width = 460, height = 400;
        var aspect = width / height;
        var chart = d3.select(chartId);

        function resizer() {
            var chart = d3.select("#distribution-curve");
            if(chart && chart.node()) {
                var targetWidth = chart.node().getBoundingClientRect().width;
                chart.attr("width", targetWidth);
                chart.attr("height", targetWidth / aspect);
            }
        }

        d3.select(window).on("resize", resizer);


        // var width = $("#distribution-curve").width(), height = $("#distribution-curve").height();

        // set the dimensions and margins of the graph
        //var margin = { top: 30, right: 30, bottom: 30, left: 50 };
        var margin = {top: 20, right: 50, bottom: 50, left: 80};
        //var width = width - margin.left - margin.right;
        //var height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*const svg = d3.select("#distribution-curve")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        */

        var svg = d3.select("#distribution-curve").append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "distribution-curve-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);


        resizeDistributionCurveSvg();


        var data = js_vars.demand_rvs;


        // add the x Axis
        var xmax = js_vars.variance_choice === "high"? 1400: 1000;
        var xAxis = d3.scaleLinear()
            .domain([0, xmax])
            .range([0, width]);
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xAxis));

        // Compute kernel density estimation
        var kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(20)) // 40
        var density = kde(data);

        // compute yAxis bounds
        var vals = [];
        density.forEach(([bin, val]) => {
            vals.push(val);
        })
        // var meanstep = d3.mean(d3.sort(vals));
        var ymax = Math.max(...vals);

        // add the y Axis
        var yAxis = d3.scaleLinear()
            .range([height, 0])
            .domain([0, ymax]); // 0.01
        var yticks = yAxis.ticks(2);
        var stepSize = yticks[1] - yticks[0]
        //yAxis = yAxis.domain([0, yticks[yticks.length-1] + stepSize])
        yAxis = yAxis.domain([0, yticks[yticks.length-1] + Math.floor(stepSize/2)])
        svg.append("g")
            .call(d3.axisLeft(yAxis));

        // Add X axis label:
        var xAxisLabel = "Units";
        svg.append("text")
            .attr("text-anchor", "end")
            .attr("x", width / 2 + 20)
            .attr("y", height + 40)
            .text(xAxisLabel)
            .style("font-size", "20px")

        // Y axis label:
        var yAxisLabel = "Probability";
        svg.append("text")
            .attr("text-anchor", "end")
            .attr("transform", "rotate(-90)")
            .attr("y", -margin.left / 2 - 10)
            .attr("x", - height / 2 + margin.top)
            .text(yAxisLabel)
            .style("font-size", "20px")

        // Plot the area
        const curve = svg
            .append('g')
            .append("path")
            .attr("class", "mypath")
            .datum(density)
            .style("fill", "#69b3a2")
            .attr("opacity", ".8")
            .attr("stroke", "#000")
            .attr("stroke-width", 1)
            .attr("stroke-linejoin", "round")
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );

        hideLoadingMessage();

        /* Listen to the slider?
        d3.select("#mySlider").on("change", function (d) {
            selectedValue = this.value;
            updateChart(selectedValue);
        });
        */

    }


    // A function that update the chart when slider is moved?
    function updateChart(binNumber) {
        showLoadingMessage();

        // recompute density estimation
        kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(binNumber));

        //density = kde(data.map(function (d) { return d.d1; }))
        density = kde(data);


        // update the chart
        curve
            .datum(density)
            .transition()
            .duration(1000)
            .attr("d", d3.line()
                .curve(d3.curveBasis)
                .x(function (d) { return xAxis(d[0]); })
                .y(function (d) { return yAxis(d[1]); })
            );
        hideLoadingMessage();
    }


    // Function to compute density
    function kernelDensityEstimator(kernel, X) {
        return function (V) {
            return X.map(function (x) {
                return [x, d3.mean(V, function (v) { return kernel(x - v); })];
            });
        };
    }
    function kernelEpanechnikov(k) {
        return function (v) {
            return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
        };
    }
    function showLoadingMessage() {
        $('#distribution-curve-loading-message').show();
    }
    function hideLoadingMessage() {
        $('#distribution-curve-loading-message').hide();
    }
</script>


<!-- unit-costs-table -->
<script>
    function updateUnitCostsTable() {
        var costsTable = $("#unit-costs-table")
        var costsWholesaleRow = $("#row-wcpu");
        var costsRetailRow = $("#row-rcpu");
        var costsHoldingRow = $("#row-hcpu");
        var wcpu = formatCurrency(js_vars.wcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );
        var rcpu = formatCurrency(js_vars.rcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );
        var hcpu = formatCurrency(js_vars.hcpu, {minimumFractionDigits: 2, maximumFractionDigits: 2} );

        costsWholesaleRow.append(`<td id="row-wcpu">${wcpu} / unit / period</td>`);
        costsRetailRow.append(`<td id="row-rcpu">${rcpu} / unit / period</td>`);
        costsHoldingRow.append(`<td id="row-hcpu">${hcpu} / unit / period</td>`);

        try {
            costsTable.bootstrapTable();
        } catch(e) {
            console.error(e);
        }

    }
</script>

<!-- hist-quantities-barchart -->
<script>
    function resizeQuantitiesBarchartSvg() {
        var aspect = 460 / 400;

        //var height = $('#hist-quantities-barchart').height();
        //var width = height * aspect;

        var width = $('#hist-quantities-barchart').width();
        var height = width / aspect;

        $('#hist-quantities-svg').css({
            'width': `${width}px`,
            'height': `${height}px`
        });
    }
    function plotQuantitiesBarchart() {
        var chartId = "#hist-quantities-barchart";
        var width = 460, height = 400;
        var aspect = width / height;
        var chart = d3.select("#hist-quantities-barchart");

        function resizer() {
            var chart = d3.select("#hist-quantities-barchart");
            if(chart && chart.node()) {
                var targetWidth = chart.node().getBoundingClientRect().width;
                chart.attr("width", targetWidth);
                chart.attr("height", targetWidth / aspect);
            }
        }

        d3.select(window).on("resize", resizer);

        // set the dimensions and margins of the graph
        var margin = {top: 50, right: 100, bottom: 50, left: 100};
        //var width = width - margin.left - margin.right;
        //var height = height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        /*var svg = chart
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
        */
        var svg = chart.append("svg")
            //.attr("width", width + margin.left + margin.right)
            //.attr("height", height + margin.top + margin.bottom)
            .attr("id", "hist-quantities-svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
            .attr("preserveAspectRatio", "none")
            .append("g")
                .attr("transform",`translate(${margin.left},${margin.top})`);


        resizeQuantitiesBarchartSvg();


        var data = JSON.parse(JSON.stringify(js_vars.history));
        var removeKeys = Object.keys(data[0]).filter(k => !["du", "ou", "period"].includes(k));
        data.forEach(d => {
            d.ou = d.ou === null? 0: d.ou;
            d.du = d.du === null? 0: d.du;
            for (var i in removeKeys) {
                delete d[removeKeys[i]];
            }
        });
        var ymax = Math.max(...data.map(d => d.ou), ...data.map(d => d.du));
        var groups = data.map(d => d.period);
        var subgroups = Object.keys(data[0]).filter(key => ["ou","du"].includes(key));

        // Add X axis
        var xAxis = d3.scaleBand()
            .domain(groups)
            .range([0, width])
            .padding([0.2]);

        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xAxis).tickSize(0));


        // Add Y axis
        var yAxis = d3.scaleLinear()
            .domain([0, ymax? ymax: 100])
            .range([ height, 0 ]);
        var yticks = yAxis.ticks(10);
        var stepSize = yticks[1] - yticks[0]
        yAxis = yAxis.domain([0, yticks[yticks.length-1] + stepSize])
        svg.append("g")
            .call(d3.axisLeft(yAxis));

        // Add X-subgroup Axis
        var xAxisSubgroup = d3.scaleBand()
            .domain(subgroups)
            .range([0, xAxis.bandwidth()])
            .padding([0.05]);


        // Add X axis label:
        var xAxisLabel = "Period";
        svg.append("text")
            .attr("text-anchor", "end")
            .attr("x", width / 2 + 40)
            .attr("y", height + 40)
            .text(xAxisLabel)
            .style("font-size", "20px")

        // Y axis label:
        var yAxisLabel = "Quantity";
        svg.append("text")
            .attr("text-anchor", "end")
            .attr("transform", "rotate(-90)")
            .attr("y", -margin.left / 2)
            .attr("x", - height / 2 + margin.top)
            .text(yAxisLabel)
            .style("font-size", "20px")


        // color palette = one color per subgroup
        var color = d3.scaleOrdinal()
            .domain(subgroups)
            .range([orderQuantityColor(), demandQuantityColor()])


        // Show the bars
        svg.append("g")
            .selectAll("g")
            // Enter in data = loop group per group
            .data(data)
            .join("g")
                .attr("transform", d => `translate(${xAxis(d.period)}, 0)`)
            .selectAll("rect")
            .data(function(d) { return subgroups.map(function(key) { return {key: key, value: d[key]}; }); })
            .join("rect")
                .attr("x", function(d) { return xAxisSubgroup(d.key); })
                .attr("y", function(d) { return yAxis(d.value); })
                .attr("width", xAxisSubgroup.bandwidth())
                .attr("height", function(d) { return height - yAxis(d.value); })
                .attr("fill", function(d) { return color(d.key); })

        // Handmade legend
        svg.append("circle").attr("cx", width - 30).attr("cy", -20).attr("r", 6).style("fill", orderQuantityColor());
        svg.append("circle").attr("cx", width - 30).attr("cy", 0).attr("r", 6).style("fill", demandQuantityColor());
        svg.append("text").attr("x", width - 20).attr("y", -20).text("Order size").style("font-size", "15px").attr("alignment-baseline", "middle")
        svg.append("text").attr("x", width - 20).attr("y", 0).text("Demand size").style("font-size", "15px").attr("alignment-baseline", "middle")

    };

</script>

<!-- hist-metrics-table -->
<script>
    function updateMetricsTable() {
        var metricsTable = $("#hist-metrics-table")
        var metricsTheadTr = $("#hist-metrics-table thead tr");
        var metricsTableStockRow = $("#hist-metrics-table #row-stock");
        var metricsTableOrderRow = $("#hist-metrics-table #row-order");
        var metricsTableDemandRow = $("#hist-metrics-table #row-demand");
        var metricsTableProfitRow = $("#hist-metrics-table #row-profit");
        var metricsTableCProfitRow = $("#hist-metrics-table #row-cprofit");
        for (var i=0; i < js_vars.history.length; i++) {
            var h = js_vars.history[i];
            var p = h.period;
            var su = formatNumber(h.su_before? h.su_before: 0, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            var ou = formatNumber(h.ou? h.ou: 0, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            var du = formatNumber(h.du? h.du: 0, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            var profit = formatCurrency(h.profit? h.profit: 0, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );
            var cumulative_profit = formatCurrency(h.cumulative_profit? h.cumulative_profit: 0, { minimumFractionDigits: 0, maximumFractionDigits: 0 } );

            if (i + 1 > js_vars.game_round) {
                su = '';
            }
            if (i + 1 >= js_vars.game_round) {
                ou = '';
                du = '';
                profit = '';
                cumulative_profit = '';
            }

            var colWidth = Math.floor(100/(js_vars.rounds + 1));
            //var colWidth = 100
            //metricsTheadTr.append(`<th scope="col" data-halign="center" data-width="${colWidth}" data-width-unit="%">${p}</th>`);

            //metricsTheadTr.append(`<th scope="col" data-halign="center" data-align="center" data-width="5" data-width-unit="%">${p}</th>`);
            //metricsTheadTr.append(`<th scope="col" data-halign="center" data-align="center">${p}</th>`);
            //metricsTheadTr.append(`<th scope="col" data-halign="center" data-align="center" class="flex-grow-0">${p}</th>`);
            metricsTheadTr.append(`<th style="white-space: nowrap;" scope="col" data-halign="center" data-align="center" >${p}</th>`); // class=""
            metricsTableStockRow.append(`<td style="min-width: 50px; white-space: nowrap; ">${su}</td>`); // class=""
            metricsTableOrderRow.append(`<td style="min-width: 50px; white-space: nowrap; ">${ou}</td>`); // class=""
            metricsTableDemandRow.append(`<td style="min-width: 50px; white-space: nowrap; ">${du}</td>`); // class=""
            metricsTableProfitRow.append(`<td style="min-width: 50px; white-space: nowrap; ">${profit}</td>`); // class=""
            metricsTableCProfitRow.append(`<td style="min-width: 50px; white-space: nowrap; ">${cumulative_profit}</td>`); // class=""
            //metricsTable.attr("data-toggle", "table");
        }

        //metricsTable.addClass("table-fit");
        //metricsTable.addClass("table-responsive");

        try {
            metricsTable.bootstrapTable();
        } catch(e) {
            console.error(e);
        }

        //metricsTable.addClass("w-100 d-block d-table");
        //metricsTable.addClass("w-100 d-block d-table");


    }
</script>


<!-- final-results-table -->
<script>
    function updateFinalResultsTables() {

        // make a "results table" for each game
        var finalResultsContainer = $("#final-results-container");
        finalResultsContainer.empty();
        var overallResults = {
            cumulative_profit: 0,
            final_inventory: 0,
            total_ordered: 0,
            total_demanded: 0,
        }
        for (var i=0; i < js_vars.game_results.length; i++) {
            var tableId = `results-table-${i}`;
            var cardTitle = `Game ${i+1} Results`;
            var cardCode = $(`<div class="col-auto"><div class="card"><div class="card-body"><h5 class="card-title text-center">${cardTitle}</h5><table id="${tableId}"></table></div></div></div>`);
            finalResultsContainer.append(cardCode);
            var table = $(`#${tableId}`);

            //table.addClass("table")
            //table.addClass("table-hover")

            //var theadCode = $(`<thead><tr><th scope="row"></th><th scope="col">Result</th></tr></thead>`);
            // var theadCode = $(`<thead><tr><th scope="row"></th><th scope="col"></th></tr></thead>`);
            // var theadCode = $(`<thead></thead>`);
            // table.append(theadCode);

            var results = js_vars.game_results[i];
            var LENGTH = results.length - 1;
            var cumulative_profit = results[LENGTH].cumulative_profit? results[LENGTH].cumulative_profit: 0;
            var final_inventory = results[LENGTH].su_after? results[LENGTH].su_after: 0;
            var total_ordered = 0;
            var total_demanded = 0;
            for (var j=0; j < results.length; j++) {
                total_ordered += results[j].ou? results[j].ou: 0;
                total_demanded += results[j].du? results[j].du: 0;
            }

            overallResults.cumulative_profit += cumulative_profit;
            overallResults.final_inventory += final_inventory;
            overallResults.total_ordered += total_ordered;
            overallResults.total_demanded += total_demanded;

            table.bootstrapTable({
                columns: [{
                    field: 'name',
                    title: ''
                }, {
                    field: 'value',
                    title: ''
                }],
                data: [{
                    id: 1,
                    name: '<strong>Total profit</strong>',
                    value: formatCurrency(cumulative_profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 } )
                }, {
                    id: 2,
                    name: '<strong>Total ordered</strong>',
                    value: formatNumber(total_ordered, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                }, {
                    id: 3,
                    name: '<strong>Total demanded</strong>',
                    value: formatNumber(total_demanded, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                }, {
                    id: 4,
                    name: '<strong>Final inventory</strong>',
                    value: formatNumber(final_inventory, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                }]
            })
            table.find('thead').empty();
        }

        var tableId = `overall-table`;
        var cardTitle = `Overall Results`;
        var cardCode = $(`<div class="col-auto"><div class="card"><div class="card-body"><h5 class="card-title text-center">${cardTitle}</h5><table id="${tableId}"></table></div></div></div>`);
        finalResultsContainer.append(cardCode);
        var table = $(`#${tableId}`);
        table.bootstrapTable({
            columns: [{
                field: 'name',
                title: ''
            }, {
                field: 'value',
                title: ''
            }],
            data: [{
                id: 1,
                name: '<strong>Total profit</strong>',
                value: formatCurrency(overallResults.cumulative_profit, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
            }, {
                id: 2,
                name: '<strong>Total ordered</strong>',
                value: formatNumber(overallResults.total_ordered, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
            }, {
                id: 3,
                name: '<strong>Total demanded</strong>',
                value: formatNumber(overallResults.total_demanded, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
            }, {
                id: 4,
                name: '<strong>Final inventory</strong>',
                value: formatNumber(overallResults.final_inventory, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
            }]
        })
        table.find('thead').empty();
    }
</script>

<script>
    if (window.location.href.includes('/Decide/')) {

        // row 1
        plotDistributionCurve();
        updateUnitCostsTable();

        // row 2
        plotQuantitiesBarchart();
        updateMetricsTable();
;
        var width = $("#distribution-curve").width();
        if ($("#distribution-curve").length > 0) {
            $("#hist-quantities-barchart").width(width);
            $("#hist-quantities-barchart").height(width / (460/400));
            resizeQuantitiesBarchartSvg();

            var widthCard = $("#distribution-card").width()
            $("#hist-quantities-card").width(widthCard);
            $("#hist-quantities-card").height(widthCard / (460/400));
        }
        //if($("#hist-quantities-barchart").width() < width) {
        //    $("#hist-quantities-barchart").width(width);
        //    $("#hist-quantities-barchart").height(width / (460/400));
        //    resizeQuantitiesBarchartSvg();
        //}
        //if($("#hist-metrics-table").width() < width) {
        //    $("#hist-metrics-table").width(width);
        //}
    } else {
        $("#scenario-info-container").hide();
        $("#historical-info-container").hide();
    }

    if (window.location.href.includes('/FinalResults/')) {
        updateFinalResultsTables();
    } else {
        $("#final-results-container").hide();
    }

</script>
